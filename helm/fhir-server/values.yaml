# Default values for fhir-server
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

# Number of replicas for the deployment
replicaCount: 3

image:
  repository: fhir-server
  pullPolicy: IfNotPresent
  # Overrides the image tag whose default is the chart appVersion.
  tag: "latest"

imagePullSecrets: []
nameOverride: ""
fullnameOverride: ""

serviceAccount:
  # Specifies whether a service account should be created
  create: true
  # Automatically mount a ServiceAccount's API credentials?
  automount: true
  # Annotations to add to the service account
  annotations: {}
  # The name of the service account to use.
  # If not set and create is true, a name is generated using the fullname template
  name: ""

podAnnotations: {}
podLabels: {}

podSecurityContext:
  runAsNonRoot: true
  runAsUser: 1000
  fsGroup: 1000
  seccompProfile:
    type: RuntimeDefault

securityContext:
  allowPrivilegeEscalation: false
  capabilities:
    drop:
    - ALL
  readOnlyRootFilesystem: true

# HTTP Service configuration
httpService:
  type: ClusterIP
  port: 8080
  targetPort: 8080
  annotations: {}

# gRPC Service configuration
grpcService:
  type: ClusterIP
  port: 50051
  targetPort: 50051
  annotations: {}

# Ingress configuration for HTTP
ingress:
  enabled: false
  className: "nginx"
  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
  hosts:
    - host: fhir.example.com
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: fhir-server-tls
      hosts:
        - fhir.example.com

# Ingress configuration for gRPC
grpcIngress:
  enabled: false
  className: "nginx"
  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/backend-protocol: "GRPC"
  hosts:
    - host: grpc.fhir.example.com
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: fhir-grpc-tls
      hosts:
        - grpc.fhir.example.com

resources:
  limits:
    cpu: 1000m
    memory: 512Mi
  requests:
    cpu: 250m
    memory: 256Mi

# Horizontal Pod Autoscaler
autoscaling:
  enabled: true
  minReplicas: 3
  maxReplicas: 10
  targetCPUUtilizationPercentage: 70
  targetMemoryUtilizationPercentage: 80

# Liveness probe configuration
livenessProbe:
  httpGet:
    path: /health
    port: http
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

# Readiness probe configuration
readinessProbe:
  httpGet:
    path: /health
    port: http
  initialDelaySeconds: 10
  periodSeconds: 5
  timeoutSeconds: 3
  failureThreshold: 3

# Startup probe configuration
startupProbe:
  httpGet:
    path: /health
    port: http
  initialDelaySeconds: 0
  periodSeconds: 5
  timeoutSeconds: 3
  failureThreshold: 30

# PostgreSQL database configuration
postgresql:
  # Set to true to deploy PostgreSQL with the chart
  enabled: true
  auth:
    username: fhir
    password: fhir_password
    database: fhir
  primary:
    persistence:
      enabled: true
      size: 10Gi
    resources:
      limits:
        cpu: 500m
        memory: 512Mi
      requests:
        cpu: 250m
        memory: 256Mi

# External database configuration (when postgresql.enabled = false)
externalDatabase:
  host: postgres.example.com
  port: 5432
  username: fhir
  password: ""
  database: fhir
  # Use existing secret for database credentials
  existingSecret: ""
  existingSecretPasswordKey: "password"

# Application configuration
config:
  # Database configuration
  database:
    maxConnections: 10
    minConnections: 2
    connectTimeout: 30
    idleTimeout: 600

  # Server configuration
  server:
    host: "0.0.0.0"
    port: 8080

  # gRPC configuration
  grpc:
    host: "0.0.0.0"
    port: 50051
    tlsEnabled: false
    # Paths to TLS cert/key if using TLS (mounted from secrets)
    tlsCertPath: "/etc/tls/tls.crt"
    tlsKeyPath: "/etc/tls/tls.key"

  # JWT configuration
  jwt:
    secret: ""  # Leave empty to use from secret
    expirationHours: 24

  # Logging configuration
  logging:
    level: "info"
    format: "json"

# TLS certificates for gRPC (if grpc.tlsEnabled = true)
grpcTLS:
  # Use existing secret for TLS certificates
  existingSecret: ""
  # Or provide cert and key directly (not recommended for production)
  cert: ""
  key: ""

# Existing secret for JWT secret key
jwtSecret:
  existingSecret: ""
  key: "jwt-secret"
  # Or provide the secret directly (not recommended for production)
  value: ""

# Node selector
nodeSelector: {}

# Tolerations
tolerations: []

# Affinity rules
affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: app.kubernetes.io/name
                operator: In
                values:
                  - fhir-server
          topologyKey: kubernetes.io/hostname

# Pod Disruption Budget
podDisruptionBudget:
  enabled: true
  minAvailable: 1
  # maxUnavailable: 1  # Use either minAvailable or maxUnavailable

# Volume mounts for temporary files
volumeMounts:
  - name: tmp
    mountPath: /tmp
  - name: cache
    mountPath: /app/.cache

# Volumes
volumes:
  - name: tmp
    emptyDir: {}
  - name: cache
    emptyDir: {}

# Service Monitor for Prometheus (if using Prometheus Operator)
serviceMonitor:
  enabled: false
  interval: 30s
  scrapeTimeout: 10s
  labels: {}
  annotations: {}
